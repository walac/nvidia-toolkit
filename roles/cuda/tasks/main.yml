#SPDX-License-Identifier: MIT-0
---
# tasks file for cuda

- name: Display CUDA installation information
  debug:
    msg:
      - "Installing CUDA {{ cuda_version }} on {{ ansible_distribution }} {{
        ansible_distribution_version }}"
      - "CUDA Home will be: {{ cuda_home }}"

- name: Set distribution-specific CUDA repository paths
  set_fact:
    cuda_dist_id: "{{ 'fedora' if ansible_distribution == 'Fedora' else 'rhel' }}"
    # Fedora version fallback: use max supported version if current is newer
    cuda_dist_version: "{{ cuda_fedora_max_version if (ansible_distribution == 'Fedora' and (ansible_distribution_major_version | int) > (cuda_fedora_max_version | int)) else ansible_distribution_major_version }}"

- name: Display repository information
  debug:
    msg:
      "Using CUDA repository for {{ cuda_dist_id }}{{ cuda_dist_version }} (running on {{
      ansible_distribution }} {{ ansible_distribution_major_version }})"

- name: Add Nvidia CUDA Repository
  yum_repository:
    name: cuda
    description: Nvidia CUDA Repository
    baseurl: "https://developer.download.nvidia.com/compute/cuda/repos/{{ cuda_dist_id }}{{ cuda_dist_version }}/{{ cuda_repo_arch }}/"
    gpgkey: "https://developer.download.nvidia.com/compute/cuda/repos/{{ cuda_dist_id }}{{ cuda_dist_version }}/{{ cuda_repo_arch }}/{{ cuda_repo_gpgkey_id }}.pub"
    gpgcheck: true
    enabled: true
    # Exclude driver packages to prevent conflict with RPM Fusion akmods
    exclude: "xorg-x11-drv-nvidia* kmod-nvidia* akmod-nvidia* nvidia-driver* nvidia-settings* *cuda-drivers* nvidia-kmod-common*"
  register: cuda_repo

- name: Update DNF cache for CUDA repository
  dnf:
    update_cache: true
  when: cuda_repo is changed

- name: Install CUDA Toolkit
  dnf:
    name: "{{ cuda_packages }}"
    state: present
  register: cuda_install

- name: Create CUDA symlink
  file:
    src: "{{ cuda_home }}"
    dest: "{{ cuda_symlink }}"
    state: link
    force: true

- name: Setup CUDA environment variables
  template:
    src: cuda.sh.j2
    dest: /etc/profile.d/cuda.sh
    owner: root
    group: root
    mode: "0644"

- name: Verify CUDA installation
  command: "{{ cuda_symlink }}/bin/nvcc --version"
  register: nvcc_check
  changed_when: false
  failed_when: nvcc_check.rc != 0

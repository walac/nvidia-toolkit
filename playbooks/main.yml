---
# ============================================
# Main Playbook: Nvidia AI Toolkit Setup
# ============================================
# This is the master playbook that orchestrates
# the complete Nvidia GPU infrastructure setup
#
# Usage:
#   ansible-playbook playbooks/main.yml
#
# Tags available:
#   - preflight: Pre-flight checks only
#   - driver: Nvidia driver installation
#   - cuda: CUDA toolkit installation
#   - inference: Inference tools
# ============================================

- name: Nvidia GPU Toolkit Complete Setup
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display setup information
      debug:
        msg:
          - "Starting Nvidia Toolkit Setup"
          - "Target OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Python: {{ ansible_python_version }}"
          - "Architecture: {{ ansible_architecture }}"
      tags: always

    - name: Pre-flight checks
      block:
        - name: Detect GPU hardware
          shell: lspci | grep -i nvidia
          register: gpu_check
          changed_when: false
          failed_when: false

        - name: Verify GPU presence
          assert:
            that: gpu_check.rc == 0
            fail_msg: "No Nvidia GPU detected on this system"
            success_msg: "Nvidia GPU detected: {{ gpu_check.stdout_lines | first | default('unknown') }}"
      tags: ["preflight", "always"]

  roles:
    # Phase 1: Nvidia Driver
    - role: nvidia-driver
      tags: ["driver", "nvidia"]

    # Phase 2: CUDA Toolkit
    - role: cuda
      tags: ["cuda", "toolkit"]

    # Phase 3: Inference Stack
    - role: inference-stack
      when: install_inference | default(true)
      tags: ["inference", "ollama"]

  post_tasks:
    - name: Display setup summary
      debug:
        msg:
          - "=========================================="
          - "Nvidia Toolkit Setup Complete"
          - "=========================================="
          - "CUDA Version: {{ cuda_version }}"
          - "Inference Tools: {{ 'Installed' if install_inference else 'Skipped' }}"
          - ""
          - "Next Steps:"
          - "  1. Verify GPU access: nvidia-smi"
          - "  2. Test CUDA: nvcc --version"
          - "  3. Test Python GPU: python3 -c 'import torch; print(torch.cuda.is_available())'"
          - "  4. Start using your GPU-accelerated environment!"
          - "=========================================="
      tags: ["always"]

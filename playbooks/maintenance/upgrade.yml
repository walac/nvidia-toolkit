---
# ============================================
# Upgrade Playbook: Nvidia Drivers and CUDA
# ============================================
# This playbook safely upgrades Nvidia drivers,
# CUDA toolkit, and related components
#
# Usage:
#   ansible-playbook playbooks/maintenance/upgrade.yml
#
# NOTE: A manual reboot may be required if driver
# updates are installed
# ============================================

- name: Upgrade Nvidia GPU Stack
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Update DNF cache
      dnf:
        update_cache: true

    - name: Upgrade Nvidia driver packages
      dnf:
        name:
          - "akmod-nvidia*"
          - "xorg-x11-drv-nvidia*"
          - "nvidia-settings"
        state: latest
      register: driver_upgrade

    - name: Upgrade CUDA packages
      dnf:
        name:
          - "cuda-toolkit-*"
        state: latest
      register: cuda_upgrade

    - name: Upgrade nvidia-container-toolkit
      package:
        name: nvidia-container-toolkit
        state: latest
      register: toolkit_upgrade

    - name: Rebuild akmods if driver was upgraded
      command: akmods --force
      when: driver_upgrade.changed
      register: akmods_rebuild

    - name: Display akmods rebuild status
      debug:
        msg: "{{ akmods_rebuild.stdout_lines }}"
      when: akmods_rebuild is defined and akmods_rebuild.changed

    - name: Regenerate initramfs if driver was upgraded
      command: dracut --force
      when: driver_upgrade.changed

    - name: Regenerate CDI spec if container toolkit was upgraded
      command: nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
      when: toolkit_upgrade.changed

  post_tasks:
    - name: Check if reboot is required
      set_fact:
        reboot_required:
          "{{ driver_upgrade.changed or (akmods_rebuild is defined and akmods_rebuild.changed) }}"

    - name: Display reboot instruction
      debug:
        msg:
          - "################################################################"
          - "# REBOOT REQUIRED                                              #"
          - "#                                                              #"
          - "# Driver or kernel modules were updated.                       #"
          - "# Please MANUALLY reboot the system to apply these changes.    #"
          - "################################################################"
      when: reboot_required

    - name: Display upgrade summary
      debug:
        msg:
          - "=========================================="
          - "Nvidia GPU Stack Upgrade Complete"
          - "=========================================="
          - "Driver upgraded: {{ 'Yes' if driver_upgrade.changed else 'No (already latest)' }}"
          - "CUDA upgraded: {{ 'Yes' if cuda_upgrade.changed else 'No (already latest)' }}"
          - "Container toolkit upgraded: {{ 'Yes' if toolkit_upgrade.changed else 'No (already
            latest)' }}"
          - "Reboot required: {{ 'Yes' if reboot_required else 'No' }}"
          - ""
          - "Verify installation:"
          - "  nvidia-smi"
          - "  nvcc --version"
          - "=========================================="

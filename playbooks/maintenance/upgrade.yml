---
# ============================================
# Upgrade Playbook: Nvidia Drivers and CUDA
# ============================================
# This playbook safely upgrades Nvidia drivers,
# CUDA toolkit, and related components
#
# Usage:
#   ansible-playbook playbooks/maintenance/upgrade.yml
#
# WARNING: This will reboot the system if driver
# updates are installed
# ============================================

- name: Upgrade Nvidia GPU Stack
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display upgrade information
      debug:
        msg:
          - "Starting Nvidia GPU stack upgrade"
          - "Target: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "This may include driver and CUDA updates"
          - "System will reboot if kernel modules are updated"

    - name: Check current driver version
      command: nvidia-smi --query-gpu=driver_version --format=csv,noheader
      register: current_driver
      changed_when: false
      failed_when: false

    - name: Display current driver version
      debug:
        msg:
          "Current Nvidia driver: {{ current_driver.stdout if current_driver.rc == 0 else 'Not
          installed' }}"

    - name: Check current CUDA version
      command: nvcc --version
      register: current_cuda
      changed_when: false
      failed_when: false

    - name: Display current CUDA version
      debug:
        msg:
          "Current CUDA: {{ current_cuda.stdout_lines[-1] if current_cuda.rc == 0 else 'Not
          installed' }}"

  tasks:
    - name: Update DNF cache
      dnf:
        update_cache: true

    - name: Upgrade Nvidia driver packages
      dnf:
        name:
          - "akmod-nvidia*"
          - "xorg-x11-drv-nvidia*"
          - "nvidia-settings"
        state: latest
      register: driver_upgrade

    - name: Upgrade CUDA packages
      dnf:
        name:
          - "cuda-toolkit-*"
          - "libcudnn*"
          - "libnccl*"
        state: latest
      register: cuda_upgrade

    - name: Upgrade nvidia-container-toolkit
      dnf:
        name: nvidia-container-toolkit
        state: latest
      register: toolkit_upgrade

    - name: Rebuild akmods if driver was upgraded
      command: akmods --force
      when: driver_upgrade.changed
      register: akmods_rebuild

    - name: Display akmods rebuild status
      debug:
        msg: "{{ akmods_rebuild.stdout_lines }}"
      when: akmods_rebuild is defined and akmods_rebuild.changed

    - name: Regenerate initramfs if driver was upgraded
      command: dracut --force
      when: driver_upgrade.changed

    - name: Regenerate CDI spec if container toolkit was upgraded
      command: nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
      when: toolkit_upgrade.changed

  post_tasks:
    - name: Check if reboot is required
      set_fact:
        reboot_required:
          "{{ driver_upgrade.changed or (akmods_rebuild is defined and akmods_rebuild.changed) }}"

    - name: Display reboot instruction
      debug:
        msg:
          - "################################################################"
          - "# REBOOT REQUIRED                                              #"
          - "#                                                              #"
          - "# Driver or kernel modules were updated.                       #"
          - "# Please MANUALLY reboot the system to apply these changes.    #"
          - "################################################################"
      when: reboot_required

    - name: Verify currently loaded driver
      command: nvidia-smi --query-gpu=driver_version --format=csv,noheader
      register: upgraded_driver
      changed_when: false
      ignore_errors: true
      when: driver_upgrade.changed

    - name: Display driver status
      debug:
        msg:
          - "Current loaded driver: {{ upgraded_driver.stdout | default('Unavailable') }}"
          - "NOTE: The updated driver version will not be active until after you reboot."
      when: upgraded_driver is defined

    - name: Verify CUDA after upgrade
      command: nvcc --version
      register: upgraded_cuda
      changed_when: false
      when: cuda_upgrade.changed

    - name: Display upgraded CUDA version
      debug:
        msg: "{{ upgraded_cuda.stdout_lines }}"
      when: upgraded_cuda is defined

    - name: Display upgrade summary
      debug:
        msg:
          - "=========================================="
          - "Nvidia GPU Stack Upgrade Complete"
          - "=========================================="
          - "Driver upgraded: {{ 'Yes' if driver_upgrade.changed else 'No (already latest)' }}"
          - "CUDA upgraded: {{ 'Yes' if cuda_upgrade.changed else 'No (already latest)' }}"
          - "Container toolkit upgraded: {{ 'Yes' if toolkit_upgrade.changed else 'No (already
            latest)' }}"
          - "System rebooted: {{ 'Yes' if reboot_required else 'No' }}"
          - ""
          - "Verify installation:"
          - "  nvidia-smi"
          - "  nvcc --version"
          - "=========================================="

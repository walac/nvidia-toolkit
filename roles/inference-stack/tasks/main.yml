#SPDX-License-Identifier: MIT-0
---
# tasks file for inference-stack

- name: Install zstd for tarball extraction
  package:
    name: zstd
    state: present

- name: Create ollama system group
  group:
    name: "{{ ollama_group }}"
    state: present
    system: true

- name: Create ollama system user
  user:
    name: "{{ ollama_user }}"
    group: "{{ ollama_group }}"
    shell: /sbin/nologin
    system: true
    create_home: false
    home: "{{ ollama_data_dir }}"
    comment: "Ollama service user"

- name: Create ollama data directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ollama_user }}"
    group: "{{ ollama_group }}"
    mode: "0755"
  loop:
    - "{{ ollama_data_dir }}"
    - "{{ ollama_models_dir }}"

- name: Create Ollama installation directory
  file:
    path: "{{ ollama_install_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Check installed Ollama version
  command: "{{ ollama_install_dir }}/bin/ollama --version"
  register: ollama_installed_version
  changed_when: false
  failed_when: false

- name: Determine if Ollama install or upgrade is needed
  set_fact:
    ollama_needs_install: "{{ ollama_installed_version.rc != 0 or ollama_version not in (ollama_installed_version.stdout | default('')) }}"

- name: Download Ollama tarball
  get_url:
    url: "{{ ollama_tarball_url }}"
    dest: "/tmp/ollama-{{ ollama_version }}.tar.zst"
    mode: "0644"
  when: ollama_needs_install

- name: Extract Ollama tarball
  unarchive:
    src: "/tmp/ollama-{{ ollama_version }}.tar.zst"
    dest: "{{ ollama_install_dir }}"
    remote_src: true
  when: ollama_needs_install
  register: ollama_extracted

- name: Create symlink to ollama binary
  file:
    src: "{{ ollama_install_dir }}/bin/ollama"
    dest: /usr/local/bin/ollama
    state: link
    force: true

- name: Configure Ollama systemd service
  template:
    src: ollama.service.j2
    dest: /etc/systemd/system/ollama.service
    owner: root
    group: root
    mode: "0644"
  register: ollama_service_config

- name: Reload systemd daemon
  systemd:
    daemon_reload: true
  when: ollama_service_config.changed

- name: Enable and start Ollama service
  systemd:
    name: ollama
    state: started
    enabled: true

- name: Restart Ollama if binary or config changed
  systemd:
    name: ollama
    state: restarted
  when: ollama_extracted is changed or ollama_service_config is changed

- name: Pull requested models
  command: "/usr/local/bin/ollama pull {{ item }}"
  loop: "{{ ollama_prepull_models }}"
  register: ollama_pull_result
  changed_when: "'downloading' in ollama_pull_result.stderr | default('')"
  when: ollama_prepull_models | length > 0
  become: true
  become_user: "{{ ollama_user }}"

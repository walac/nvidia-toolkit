#SPDX-License-Identifier: MIT-0
---
# tasks file for nvidia-driver

- name: Verify this is a RedHat-based system
  fail:
    msg:
      "This role currently only supports RedHat/Fedora/Rocky systems. Detected: {{ ansible_os_family
      }}"
  when: ansible_os_family != 'RedHat'

- name: Display system information
  debug:
    msg:
      - "Installing Nvidia drivers on {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "Kernel version: {{ ansible_kernel }}"
      - "Architecture: {{ ansible_architecture }}"

- name: Install kernel development packages
  package:
    name:
      - kernel-devel
      - kernel-headers
      - gcc
      - make
      - dkms
      - elfutils-libelf-devel
    state: present

- name: Set distribution-specific repository paths
  set_fact:
    repo_dist_id: "{{ 'fedora' if ansible_distribution == 'Fedora' else 'el' }}"

- name: Enable RPM Fusion Free repository
  dnf:
    name:
      "https://mirrors.rpmfusion.org/free/{{ repo_dist_id }}/rpmfusion-free-release-{{
      ansible_distribution_major_version }}.noarch.rpm"
    state: present
    disable_gpg_check: true

- name: Enable RPM Fusion Non-Free repository
  dnf:
    name:
      "https://mirrors.rpmfusion.org/nonfree/{{ repo_dist_id }}/rpmfusion-nonfree-release-{{
      ansible_distribution_major_version }}.noarch.rpm"
    state: present
    disable_gpg_check: true

- name: Install Nvidia driver packages from RPM Fusion
  dnf:
    name: "{{ nvidia_driver_packages }}"
    state: present
    enablerepo: rpmfusion-nonfree
  register: nvidia_install

- name: Wait for akmods to build kernel modules
  command: akmods --force
  register: akmods_build
  changed_when: "'Rebuilding' in akmods_build.stdout or 'Building' in akmods_build.stdout"
  failed_when: akmods_build.rc != 0
  when: nvidia_install.changed
  tags: [akmods]

- name: Display akmods build output
  debug:
    var: akmods_build.stdout_lines
  when: akmods_build.changed

- name: Check if nvidia kernel module exists
  find:
    paths: "/lib/modules/{{ ansible_kernel }}"
    patterns: "nvidia.ko*"
    recurse: true
    file_type: file
  register: nvidia_module

- name: Display nvidia module status
  debug:
    msg:
      "{{ 'Nvidia kernel module found' if nvidia_module.matched > 0
      else 'WARNING: Nvidia kernel module not found - may require reboot' }}"

- name: Enable nvidia-persistenced service
  systemd:
    name: nvidia-persistenced
    enabled: true
    state: started
  register: persistenced_result
  failed_when:
    - persistenced_result is failed
    - "'could not find' not in (persistenced_result.msg | default('') | lower)"
  when: nvidia_module.matched > 0

- name: Display reboot instruction
  debug:
    msg:
      - "################################################################"
      - "# REBOOT REQUIRED                                              #"
      - "#                                                              #"
      - "# Nvidia drivers were installed or updated.                    #"
      - "# Please reboot the system to load the new kernel modules.     #"
      - "################################################################"
  when: nvidia_install.changed
